<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ad Creative Optimizer</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; padding: 0; }
    header { padding: 24px; border-bottom: 1px solid #ddd; }
    h1 { margin: 0; font-size: 20px; }
    main { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    fieldset { border: 1px solid #ccc; margin-bottom: 16px; padding: 16px; border-radius: 8px; }
    legend { padding: 0 8px; }
    label { display: block; font-weight: 600; margin-top: 8px; }
    input, textarea, select { width: 100%; padding: 10px; margin-top: 4px; border-radius: 6px; border: 1px solid #bbb; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    button { background: #111827; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; margin-top: 12px; }
    button.secondary { background: #374151; }
    pre, code { white-space: pre-wrap; word-wrap: break-word; }
    .result { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: 16px; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .small { font-size: 12px; color: #6b7280; }
  </style>
</head>
<body>
  <header>
    <h1>Ad Creative Optimizer</h1>
    <div class="small">Pulls ad performance, analyzes creatives, and generates 3 optimized variations.</div>
  </header>
  <main>
    <form id="optimizerForm">
      <fieldset>
        <legend>Brand & Campaign</legend>
        <div class="row">
          <div>
            <label for="brandName">Brand Name</label>
            <input id="brandName" placeholder="Acme Co" required />
          </div>
          <div>
            <label for="audience">Audience</label>
            <input id="audience" placeholder="e.g., Busy parents in the US" required />
          </div>
        </div>
        <label for="product">Product / Offer</label>
        <textarea id="product" rows="3" placeholder="Describe product, value props, offer" required></textarea>
        <label for="brandVoice">Brand Voice (optional)</label>
        <input id="brandVoice" placeholder="Friendly, trustworthy, concise" />
      </fieldset>

      <fieldset>
        <legend>Data Source</legend>
        <label for="source">Source</label>
        <select id="source">
          <option value="facebook">Facebook Ads (server fetch)</option>
          <option value="custom">Custom CSV/JSON (paste)</option>
        </select>

        <div id="facebookFields">
          <div class="row">
            <div>
              <label for="fbToken">Facebook Access Token</label>
              <input id="fbToken" placeholder="EAAB... (optional if server has env)" />
            </div>
            <div>
              <label for="fbAccount">Ad Account ID</label>
              <input id="fbAccount" placeholder="act_1234567890" />
            </div>
          </div>
        </div>

        <div id="customFields" style="display:none;">
          <label for="customData">Paste CSV or JSON creative performance</label>
          <textarea id="customData" rows="8" placeholder="CSV headers: id,headline,primaryText,description,cta,imageUrl,impressions,clicks,ctr,cpc,conversions,costPerConversion,roas"></textarea>
        </div>
      </fieldset>

      <div class="flex">
        <button type="submit">Analyze & Generate</button>
        <button id="copyWebhook" type="button" class="secondary">Copy Webhook URL</button>
      </div>
      <div class="small">Webhook: <code id="webhookUrl">/api/webhook</code></div>
    </form>

    <div id="results" class="result" style="display:none;"></div>
  </main>

  <script>
    const form = document.getElementById('optimizerForm');
    const source = document.getElementById('source');
    const facebookFields = document.getElementById('facebookFields');
    const customFields = document.getElementById('customFields');
    const results = document.getElementById('results');
    const webhookEl = document.getElementById('webhookUrl');

    webhookEl.textContent = `${location.origin}/api/webhook`;

    source.addEventListener('change', () => {
      const val = source.value;
      facebookFields.style.display = val === 'facebook' ? 'block' : 'none';
      customFields.style.display = val === 'custom' ? 'block' : 'none';
    });

    document.getElementById('copyWebhook').addEventListener('click', async () => {
      await navigator.clipboard.writeText(`${location.origin}/api/webhook`);
      alert('Webhook URL copied to clipboard');
    });

    async function callAnalyze(payload) {
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    function renderResults(data) {
      results.style.display = 'block';
      const { topCreatives, bottomCreatives, insights, variations } = data;
      results.innerHTML = `
        <h3>Insights</h3>
        <div class="row">
          <div>
            <strong>What Worked</strong>
            <ul>${(insights?.whatWorked||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
          </div>
          <div>
            <strong>What Didn't Work</strong>
            <ul>${(insights?.whatDidntWork||insights?.whatDidn'tWork||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
          </div>
        </div>
        <h3>Top Creatives</h3>
        <ol>${(topCreatives||[]).map(c=>`<li><strong>${c.headline||c.name||c.id||'Creative'}</strong> ? CTR ${c.ctr||'-'} | CV ${c.conversions||0}</li>`).join('')}</ol>
        <h3>Bottom Creatives</h3>
        <ol>${(bottomCreatives||[]).map(c=>`<li><strong>${c.headline||c.name||c.id||'Creative'}</strong> ? CTR ${c.ctr||'-'} | CV ${c.conversions||0}</li>`).join('')}</ol>
        <h3>Generated Variations</h3>
        ${(variations||[]).map((v,i)=>`
          <div style="border:1px solid #ddd;padding:12px;border-radius:8px;margin:8px 0;">
            <div class="small">Variation ${i+1}</div>
            <div><strong>Headline:</strong> ${v.headline||''}</div>
            <div><strong>Primary Text:</strong> ${v.primaryText||''}</div>
            <div><strong>Description:</strong> ${v.description||''}</div>
            <div><strong>CTA:</strong> ${v.cta||''}</div>
            <button onclick='navigator.clipboard.writeText(${JSON.stringify('')});' style="display:none">copyHidden</button>
            <button onclick='navigator.clipboard.writeText(JSON.stringify(${JSON.stringify({})}))' style="display:none">copyHidden2</button>
            <button onclick='navigator.clipboard.writeText(`${v.headline}\n\n${v.primaryText}\n\n${v.description}\nCTA: ${v.cta}`)'>Copy Variation</button>
          </div>
        `).join('')}
      `;
    }

    function parseCustomData(text) {
      try {
        return { creativeMetrics: JSON.parse(text) };
      } catch {
        // Attempt CSV
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (lines.length < 2) return { creativeMetrics: [] };
        const headers = lines[0].split(',').map(h=>h.trim());
        const rows = lines.slice(1).map(line => {
          const cols = line.split(',');
          const obj = {};
          headers.forEach((h, idx) => obj[h] = cols[idx]);
          ['impressions','clicks','conversions'].forEach(k=>{ if(obj[k]!==undefined) obj[k]=Number(obj[k]||0); });
          ['ctr','cpc','costPerConversion','roas'].forEach(k=>{ if(obj[k]!==undefined) obj[k]=Number(obj[k]||0); });
          return obj;
        });
        return { creativeMetrics: rows };
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      results.style.display = 'block';
      results.textContent = 'Running analysis...';
      try {
        const payload = {
          brand: {
            name: document.getElementById('brandName').value,
            voice: document.getElementById('brandVoice').value,
            audience: document.getElementById('audience').value,
            product: document.getElementById('product').value,
          },
          source: source.value,
          numVariants: 3
        };
        if (source.value === 'facebook') {
          payload.facebook = {
            accessToken: document.getElementById('fbToken').value || undefined,
            adAccountId: document.getElementById('fbAccount').value
          };
        } else if (source.value === 'custom') {
          Object.assign(payload, parseCustomData(document.getElementById('customData').value));
        }
        const data = await callAnalyze(payload);
        renderResults(data);
      } catch (err) {
        results.textContent = `Error: ${err.message}`;
      }
    });
  </script>
</body>
</html>
